<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>8-bitars ALU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
  <header>
    <div class="wrap">
      <h1>8-bitars ALU (A,B)</h1>
      <nav><a href="../index.html">Hem</a> <a href="../modules/04-aritmetiska-nat.html">Modul 04</a></nav>
    </div>
  </header>
  <main>
    <div class="card">
      <div class="field">
        <label for="ain">A</label><input id="ain" type="text" value="0x3C">
        <label for="bin">B</label><input id="bin" type="text" value="0x12">
        <label for="op">Operation</label>
        <select id="op">
          <option value="AND">AND</option>
          <option value="OR">OR</option>
          <option value="XOR">XOR</option>
          <option value="NOT">NOT A</option>
          <option value="ADD" selected>ADD</option>
          <option value="SUB">SUB (A−B)</option>
          <option value="INC">INC A</option>
          <option value="DEC">DEC A</option>
          <option value="SHL">SHL A</option>
          <option value="SHR">SHR A</option>
        </select>
      </div>
      <div class="field">
        <label style="width:auto"><input id="signed" type="checkbox" checked> Tolka som tvåkomplement (för V-flagga)</label>
        <button id="run">Kör</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h3>Resultat</h3>
        <div class="mono" id="res">—</div>
        <div class="small" id="flags">Z N C V: —</div>
      </section>
      <section class="card">
        <h3>Binärt</h3>
        <div class="mono small" id="binview">—</div>
      </section>
    </div>

    <div class="card alert small">
      Tips: Z=0 när resultat ≠ 0. N=MSB. C=bärcarry/borrow beroende på operation. V=signed overflow vid ADD/SUB.
    </div>
  </main>
  <footer><main>© <span id="y"></span> Datorteknik</main></footer>

  <script>
    const $=id=>document.getElementById(id);
    const mask=0xFF;
    const parseV = (s)=> {
      s=s.trim();
      if(/^0x/i.test(s)) return parseInt(s,16)&mask;
      if(/^[01]+b$/i.test(s)) return parseInt(s,2)&mask;
      return (parseInt(s,10)|0)&mask;
    };
    const padBin = u=> (u>>>0).toString(2).padStart(8,'0').replace(/(.{4})/g,"$1 ").trim();
    const padHex = u=> "0x"+(u>>>0).toString(16).toUpperCase().padStart(2,'0');
    const s8 = u => (u & 0x80) ? (u - 256) : u;

    function alu(A,B,op,signed){
      let R=0, C=0, V=0;
      switch(op){
        case 'AND': R = A & B; break;
        case 'OR':  R = A | B; break;
        case 'XOR': R = A ^ B; break;
        case 'NOT': R = (~A)&mask; break;
        case 'INC': { const t=A+1; R=t&mask; C=(t>>8)&1; V=(A===0x7F)?1:0; break; }
        case 'DEC': { const t=A-1; R=t&mask; C=(A===0)?0:1; V=(A===0x80)?1:0; break; }
        case 'SHL': { C=(A>>7)&1; R=(A<<1)&mask; break; }
        case 'SHR': { C=A&1; R=(A>>>1)&mask; break; }
        case 'ADD': {
          const t=A+B; R=t&mask; C=(t>>8)&1;
          if (signed){ const sa=(A>>7)&1,sb=(B>>7)&1,sr=(R>>7)&1; V=(sa===sb && sr!==sa)?1:0; }
          break;
        }
        case 'SUB': {
          const t=A + ((~B)&mask) + 1; R=t&mask; C=((A>>>0) >= (B>>>0))?1:0;
          if (signed){ const sa=(A>>7)&1,sb=(B>>7)&1,sr=(R>>7)&1; V=(sa!==sb && sr!==sa)?1:0; }
          break;
        }
      }
      const Z = (R===0)?1:0, N=(R>>7)&1;
      return {R, flags:{Z,N,C,V}};
    }

    function run(){
      const A = parseV($('ain').value), B=parseV($('bin').value);
      const op = $('op').value, signed = $('signed').checked;
      const {R, flags} = alu(A,B,op,signed);
      $('res').textContent = `${padHex(R)}  (unsigned=${R}, signed=${s8(R)})`;
      $('flags').textContent = `Z=${flags.Z} N=${flags.N} C=${flags.C} V=${flags.V}`;
      $('binview').textContent = `A: ${padBin(A)}\nB: ${padBin(B)}\n—\nR: ${padBin(R)}`;
    }

    $('run').addEventListener('click', run);
    ['ain','bin','op','signed'].forEach(id=>$(id).addEventListener('input', run));
    $('y').textContent = new Date().getFullYear();
    run();
  </script>
</body>
</html>
